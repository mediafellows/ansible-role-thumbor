---
# Installs Thumbor and the AWS plugin, and configures thumbor and supervisord

# The tc_aws thumbor depency doesn't guarantee a specific range of thumbor versions,
# so this is to work around that issue: https://github.com/thumbor-community/aws/issues/56
- name: Install specific Thumbor package version (when specific version given)
  pip:
    name: thumbor
    version: "{{ thumbor_specific_version }}"
    state: present
  when: thumbor_specific_version is defined

# tc_aws adds S3 storage support to thumbor see https://github.com/thumbor-community/aws
- name: Install python packages for Thumbor (as tc_aws depends on thumbor we just use that here to pull all requirements)
  pip:
    name: tc_aws
    version: "{{ thumbor_aws_plugin_version }}"
    state: present

# Workarround for https://github.com/thumbor-community/aws/issues/62 , can be deleted once the issue is resolved
- name: Ensure we have specific version of the pyhon package botocore as newer ones break tc_aws s3 result storage
  pip: name=botocore state=absent # Uninstall current version
  ignore_errors: yes
- pip: name=botocore version=1.3.7 state=present

- name: Ensure we have specific version of the pyhon package certifi installed (to make SSL work on Ubuntu 14.04)
  pip: name=certify state=absent # Uninstall current version
  ignore_errors: yes
  # Install last working version with Ubuntu 14.04s version of openssl,
  # see https://github.com/certifi/python-certifi/issues/26#issuecomment-138334830 for the issue.
- pip: name=certifi version=2015.04.28 state=present

- name: Create a system group for thumbor user (named after user)
  group:
    name: "{{ thumbor_user }}"
    system: yes
    state: present

- name: Ensure system user for thumbor existis
  user:
    name: "{{ thumbor_user }}"
    group: "{{ thumbor_user }}"
    system: yes
    state: present

- name: Create thumbor config directory
  file:
    path: "{{ thumbor_config_dir }}"
    state: directory
    owner: root
    group: root
    mode: 0775

- name: Create thumbor configuration
  template:
    src: thumbor.conf.j2
    dest: "{{ thumbor_config_dir }}/thumbor.conf"
    owner: root
    group: "{{ thumbor_user }}"
    mode: 0640

- name: Ensure thumbor storage dir exists
  file:
    path: "{{ thumbor_storage_path }}"
    state: directory
    owner: "{{ thumbor_user }}"
    group: "{{ thumbor_user }}"
    mode: 0755

- name: Ensure thumbor log dir exists
  file:
    path: "{{ thumbor_log_dir }}"
    state: directory
    owner: root
    group: root
    mode: 0755

- name: Ensure supervisord log dir exists
  file:
    path: "{{ supervisord_log_dir }}"
    state: directory
    owner: root
    group: root
    mode: 0755

- name: Make sure supervisord service is enabled to start on boot
  service:
    name: supervisor
    enabled: yes

- name: Copy supervisord config file (which spawns the thumbor processes)
  template:
    src: supervisord.conf.j2
    dest: "/etc/supervisor/supervisord.conf"
  notify:
    - restart supervisor
